#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Wed Feb 15 12:06:57 2023

@author: alain
"""


""" TAGS
 handrail:left max_level oneway:bicycle razed:building check_date:surface ref:mhs police:FR owner
 ref:FR:prix-carburants craft supermarket addr:street note:en fuel:diesel disabled shop:gas
 guest_house email_1 scuba_diving:spoken_languages vehicle:conditional destination:symbol:backward embankment apparition lanes:bus:backward
 contact:facebook organic tee smoking design attraction electrified razed
 climbing was:description bus_bay ref:FR:SIREN hoops disused:amenity scuba_diving:type old
 sidewalk:left:bicycle boat ship townhall:type footway:surface capacity:tents genus source:addr
 icao parking:lane:right osmc:symbol socket:typee compressed_air duration ref:FR:LaPoste alt_name
 ramp:wheelchair contact:phone product parking:lane:left medical_system:western junction:ref screen fixme
 addr:unit ref:arlhs maxwidth floating scuba_diving:courses proposed:railway community:gender recycling:rubble
 passenger_lines motorboat cycleway:lane delivery:covid19 addr:city pilgrimage waste parking_space
 name_1 monitoring:particulate_matter maxspeed:hgv:backward visibility free_flying:site building_1 maxheight:signed destroyed:building
 payment:coins payment:maestro class:bicycle generator:method ruined:building contact:vhf name:ko is_in:town
 drink contact:linkedin razed:railway scuba_diving:maxdepth recycling_type surface:note turn:lanes ford
 ref:EU:ENTSOE_EIC 3dr:height2 amenity_2 stroller railway:position:exact ref:FR:NAF lanes:forward bic
 lit produce fence:type informal stars construction:generator:method name:oc ref:INSEE:city
 artist_name capacity:caravans postal_code source:note source:name:oc goods railway:preserved addr:full
 memorial ref:FR:BNCLC psv source:ref:FR:ANFR parking:lane:left:parallel official_name tracks payment:american_express
 amenity_1 wikimedia_commons website_1 maxweight:signed resort scuba_diving:education disused:highway trees
 backcountry roof:levels bicycle:sales frequency ruins:bridge:support name:jam dispensing disused:railway
 image openfire coach date_on taxi building:colour maxweight supermarket:FR
 place_of_worship aerialway:occupancy was:intermittent source:maxspeed:forward description:landuse service:vehicle:tyres opening_hours number_of_apartments
 destroyed:bridge golf_cart bridge:support sac_scale_ref mtb:name office hgv seamark:light:2:range
 protect_class insurance wheelchair recycling:scrap_metal destination:ref:backward ref:FR:INSEE:city takeaway substation
 parking:lane:right:maxstay addr:place check_date:cycleway via_ferrata_scale bridge:structure police ref shooting
 plant:method type ref:FR:GendarmerieNationale historic:civilization service:bicycle:repair cycleway:right:segregated tents theatre:genre
 bicycle recycling:tires highway seamark:mooring:category free_flying:paragliding vending communication seamark:light:2:colour
 ferry seamark:building:function steps construction_date gayfriendly education url source_ref
 recycling:garden_waste ship:type ref:FR:SIRET placement:forward reef plant:output:electricity seamark:obstruction:category CLC:year
 payment:cryptocurrencies horse cycleway:left:oneway seamark:type library:type species:fr street_cabinet priority
 whitewater barrier indoor_seating ramp parking:condition:both parking:lane:side:right destroyed:building:part fire_service
 est_width fuel:e10 contact:postcode destination:ref parking:lane foot:conditional drink:wine moped
 leaf_type source:man_made address horse:conditional source:outline contact:phone_1 recycling:plastic wires
 species:wikidata recycling:plastic_bottles aerodrome access:covid19 capacity camping_car healthcare:speciality seamark:rock:water_level
 abandoned:highway placement:start garden date sauna health_specialty:allergology cycleway:width monitoring:weather
 ref:FR:INPN ref:FR:FANTOIR seamark:cable_submarine:name trail_visibility carpool award shelter:operator pilgrimage:origin
 information male safety_rope motorcycle:repair charge hiking cycleway:left:segregated source:tunnel
 acc lock heritage:operator shelter:ref tourist_bus ref:FR:CNC fuel:lpg recycling:glass
 animal_keeping 3dr:length1 building:levels was:natural 3dr:roof railway:kvb ouverture government
 forestry access:snow source:heritage incline abandoned:landuse maxheight:marine contact:email agricultural
 gas fountain seamark:light:2:height route community:fr seamark:wreck:category payment:visa_electron park_ride
 seamark:information nohousenumber caravans ref:FR:gdo bollard scuba_diving:air_fill placement:end drinking_water:legal
 destination:ref:forward recycling:bulky_waste building:shape canal name:right scuba_diving:access_easyness windmill:disused community
 outdoor_seating tourism research_institution cycleway:both generator:output:electricity source:access demolished:highway indoor
 opening_day network air_conditioning lanes:both_ways created_by utility seamark:light:sequence lifeguard
 seamark:light:3:group boat:repair leisure destination:symbol check_date:lit ref:FR:PTT playground:theme sport
 lanes:backward railway:preferred_direction colonnade:left source:date sinkhole loading_gauge noexit parking:lane:both:diagonal
 foot seamark:light:1:colour delivery payment:google_pay maxaxleload source:bridge aerialway:bubble was:amenity
 aeroway generator:source hgv:lanes surface:colour maxspeed:advisory dogs recycling:metal roof:orientation:compass
 depot maxspeed:practical private name:ru scuba_diving:equipment length mooring levels
 trade harbour seamark:restricted_area:restriction disused:name sport_1 osmc:ref hazmat opening_hours:url
 fast_food name:de memorial:conflict addr:interpolation ref:FR:SINOE heritage toilets:handwashing source:maxspeed
 rental raceway ref:hiking motorcar gauge railway:traffic_mode trolley:parking automated
 incline_steep ref:FR:SNCF_Reseau branch count wreck:visible_at_low_tide toilets:disposal toilets:wheelchair diet:halal
 sidewalk:right:surface lanes:unmarked phone intermittent navigationaid healthcare ruins:bridge ref:FR:GendarmerieNationale_1
 mhs:inscription_date source:shop leaf_cycle 3dr:type destination:colour seamark:light:2:sector_end brand:en operator:wikidata
 end_date operator:short_name construction:power motorcar:conditional emergency cobblestone chalet driveway
 railway:tvm seamark:light:1:group source:sport line fuel:electricity change_machine bulk_purchase addr:inclusion
 abandoned:bridge official parking:lane:both description:FR piste:difficulty uic_ref seamark:light:2:character sandwich
 destination:backward iata recycling:radiograph service maxweight:bus hazmat:water bus turn:lanes:forward
 check_date:tracktype ref:FR:RTE power_supply parking:condition:right species toilets roof:angle fuel:e85
 material changing_table water_slide ramp:bicycle water_point covered destination:lanes wikipedia
 aerialway:bicycle oneway:bus abandoned addr:postcode footway contact:housenumber parking:lane:right:capacity social_facility:for_2
 ref:colour cycleway:both:lane maxstay parking:lane:left:capacity source:maxheight speed maxspeed:forward unisex
 border_type seamark:light:3:period min_level building:part contact:instagram maritime mtb payment:cards
 scuba_diving:difficulty height shelter fuel:octane_98 architect parking:lane:right:parallel building:condition political_division
 name:signed overtaking busway:right source:intermittent cuisine path sidewalk:both old_ref
 plant:source pets_allowed cemetery seamark:landmark:category contact:city locked river old_name
 note:railway ramp:stroller junction scuba_diving:depth overtaking:backward building:flats tourist_tax fuel:octane_95
 is_in plant socket:type2 oven amenity:restaurant atm motor_vehicle recycling:batteries
 landcover self_service light_source public_transport abandoned:building distance tidal parking:condition:right:vehicles
 roof:shape contact:mobile abandoned:tourism payment:visa level disused:military shop was:waterway
 wall wheelchair:description:fr payment:description seamark:light:group name:fr maxspeed:backward hour_off ref:aladin
 maxlength capacity:women to roof:colour from building ref:EU:EVSE start_date
 community_centre:for medical_supply payment:meal_voucher local_ref route_ref note:qadastre weather:radar aerialway
 bicycle_parking agriculture blind survey:date de stove waterway fax
 usage pizza award:ARPE operator:short handicap maxspeed:type cycleway diameter
 fee:conditional truck bicycle:conditional name:ja CLC:id hot_water contact:twitter ref:FR:RTE_nom
 orientation hike payment:contactless source:power roof:orientation phases destination:int_ref addr:housename
 int_ref sanitary_dump_station:grey_water pipeline ele passing_places hov parking:lane:side:left area:highway
 two_sided ref:sandre tower:construction ref:wmo operator:website maxspeed:hgv:forward addr:description segregated
 cycleway:right:oneway snowmobile communication:microwave cabins trolley:deposit cycleway:left:lane mobile parking:lane:capacity
 shoulder:right basilica was:highway tickets:public_transport hour_on generator:type capacity:disabled par
 addr:housenumber wetland proposed:railway:etcs kerb seamark:light:1:sector_start source:width water scuba_diving:nitrox
 check_date:opening_hours seamark:light:1:period damage:date archaeological_site trolley:emp protection_title access:disabled cycleway:right
 roof:direction lane_markings source:amenity garden:type website abandoned:man_made seamark:light:1:character whitewater:section_grade
 inscription recycling:textile traffic_sign amenity opening_hours:signed seamark:light:3:sector_end trailblazed megalith_type
 stairs rooms service_times city fixme:name restaurant short_name ref:FR:RegionSUD
 pastry sidewalk:left:surface shoulder:width cycleway:right:width access cinema:3D narrow mtb:scale:imba
 recycling:paper_packaging residential was:bridge valid_from name:en min_age wikidata ruins:building
 was:source acoustic roof railway:etcs voltage boat:sales motorcycle:conditional motorcycle:sales
 aerialway:heating scuba_diving:trimix disused:tourism telecom:medium payment:electronic_purses castle_type destination seamark:light:colour
 interdiction ref:FR:CEF motorhome showcase:length sanitary_dump_station:chemical_toilet recycling:small_appliances ref:FR:museofile railway
 destroyed ref:isil grassland source:maxweight golf ramp:luggage motor_vehicle:conditional colour
 beds destroyed:natural denotation fire_station:type:FR ref:UAI seamark:light:height boundary ruins
 services facebook fire_hydrant:diameter seamark:landmark:function traffic_calming seamark:light:character source:building maxweightrating
 grape_variety ref:FR:SDIS social_facility:for_1 washing_machine shoulder:surface bin seamark:light:1:sector_end detail
 brand:wikidata oneway:conditional email backrest man_made toilets:position area crop
 vehicle seamark:light:3:character mtb:type telecom recycling:newspaper permanent_camping sidewalk:both:surface drinking_water
 boules capacity:caravan disused name health_facility:type source:junction seamark:small_craft_facility:category motorcycle
 ref:ARPE:2020 service:bicycle:retail clothes castle_type:fr tactile_paving building:max_level ref:admiralty health_specialty:radiology
 tracktype nudism telescope:type garden:style layer source:ref settlement_type placement
 swimming_pool demolished note roof:material source:geometry drive_through mtb:scale:color ref:FR:FINESS
 trailer tower:type source:maxspeed:backward parking:condition denomination horse_scale oneway importance
 basin highway_1 opening_hours:covid19 military hazard slipway:type maxweight:goods handrail:center
 source population alcohol cyclestreet conveying demolished:building bar disused:leisure
 crossing:island supervised sidewalk:right:bicycle maxspeed:hgv access:conditional cycleway:left:width salt campers
 addr:street_1 seamark:light:3:colour lockable place meadow name:cs capacity:bicycle seamark:light:3:sector_start
 addr:country tunnel fee recycling:cartons fuel:adblue source:url ref:FR:SDIS:CIE seamark:light:1:height
 drive_in recycling:glass_bottles ref:DFCI crossing research preschool seamark:light:3:range cutting
 stamping_machine theatre:type recycling:books post_office mtb:scale seamark:light:1:sequence recycling:wood seamark:name
 name:etymology:wikidata club tourism_1 disused:man_made cycleway:surface seamark:light:2:period phone:FR diet:pescetarian
 maxspeed smoothness capacity:parent width building:material operator:wikipedia artist:website name:la
 seating min_height reservation school:FR level_name camping cycleway:right:lane religion
 step_count disabled_spaces cycleway:left ref:FR:ANFR sidewalk:right recycling:oils categorie_piscicole payment:apple_pay
 not:name allotments maxspeed:hazmat step:condition ref:FR:SDIS:GRPT seamark:light:2:group recycling:plastic_packaging comment
 proposed name:left historic priority_road payment:credit_cards railway:track_ref shoulder building:architecture
 maxheight:physical recycling:waste loc_name opening_date payment:visa_debit bench tomb max_age
 reservoir_type ref:nga construction crossing_ref ruins:barrier date_off copy_facility description:fr
 disused:landuse destroyed:man_made zoo fireplace operator:type entrance first_aid:care animal_shelter
 bath:type abandoned:railway seamark:restricted_area:category addr:suburb recycling:electrical_appliances bath:open_air seamark:light:3:sequence health_person:type
 laundry_service shower ref:inspire recycling:cans restriction busway transformer destination:symbol:forward
 ref:FR:INSEE:local_authority location minspeed:forward recycling:green_waste destination:colour:forward building:use kindergarten:FR destroyed:highway
 female brand:wikipedia tunnel:name recycling:electrical_items turn:lanes:backward consulting authentication:none seamark:cable_submarine:category
 static_caravans bridge:name content circuits noname social_facility:for mtb:scale:uphill museum
 parking:orientation maxspeed:conditional mofa structure depth roof:height roller_coaster boat:rental
 disabled:landuse payment:debit_cards operator natural admin_level shop:convenience note:fr nursery
 not:brand:wikidata payment:notes zone:maxspeed parking ski RIB elevator sidewalk:left
 FIXME source:name:fr observatory:type language:de diet:vegetarian animal_boarding check_date fenced
 restriction:caravan recycling:magazines train room seamark:light:range seasonal payment:cash agrarian
 seamark:light:period capacity:charging elevation recycling:cardboard amenity_3 substance seamark:light:reference source:route
 shelter_type caravan pet type:FR:FINESS destination:colour:backward toll seamark:light:3:height recycling:clothes
 grades ref:FR:CCI source:modif 3dr:height1 cables contact:street construction:generator:source ref:vatin
 seamark:harbour:category sanitary_dump_station outdoor source_1 aerialway:duration water_tank:volume sidewalk:left:segregated brewery
 scuba_diving:organization sac_scale currency:EUR dog name:frp surface int_name bicycle:type
 email_2 second_hand bicycle_road power social_facility:for_3 source:website piste:type internet_access:fee
 railway:bidirectional destination:forward recycling:paper indoor:level seamark:light:2:sector_start pumping_station maxweight:conditional phone_1
 bridge addr:flats isced:level gas_insulated disused:aeroway scuba_diving:rental handrail:right oaci
 industrial alt_name:fr handrail destroyed:surface seamark:light:2:sequence source:maxspeed:hgv dance:teaching description
 lanes artwork_type wreck:visible_at_high_tide trolley mapillary site_type source:name maxspeed:goods
 toilets:access social_facility lines phone:mobile dock canoe sidewalk community_centre
 fence_type wheelchair:description maxheight was:landuse landuse building:levels:underground brand payment:cheque
 internet_access payment:mastercard description:covid19 mtb:scale:colour house seamark:light:1:range CLC:code brand:website
 contact:fax vending_machine was:name stationery building:min_level direction contact:website playground
 damage:type animal_keeping:type railway:radio site disused:local_ref aerialway:capacity
 """

import osmium as osm
import numpy as np

# ====================================================================================================
# Conversions GPS / xy

EARTH_RADIUS = 6371000
EARTH_CIRC   = EARTH_RADIUS*2*3.1415926535

def lonlat_to_xy(lon, lat, xy0 = (0, 0)):
    
    # ----- Circumference at given latitude
    
    circ = EARTH_CIRC*np.cos(np.radians(lat))
    
    # ----- Ratio of the circumference
    
    x = xy0[0] + lon*(circ/360)
    y = xy0[1] + lat*(EARTH_CIRC/360)
    
    return x, y

def xy_to_lonlat(x, y, xy0=(0, 0)):
    
    # ----- Latitude in radians
    
    lat_rad = (y - xy0[1])/EARTH_RADIUS

    # ----- Circumference at this latiude
    
    circ = EARTH_CIRC*np.cos(lat_rad)
    
    # ----- Got it
    
    lon = (x - xy0[0])*(360/circ)
    lat = np.degrees(lat_rad)
    
    return lon, lat

# ----- Compute the pivot xy0 such as given (lon, lat) is mapped at given (x, y)

def lonlat_pivot(lon, lat, x, y):
    x0, y0 = lonlat_to_xy(lon, lat)
    return (x - x0, y - y0)


# PIVOT
# pixel: (-2501 m, -14976.5 m)
# lat lon : 43.52115, 7.03489

XY0 = (-2501, -14976.5)
PIVOT = lonlat_pivot(7.03489, 43.52115, XY0[0], XY0[1])


# AREA
# Var
# area xy -115516.79623936638 -74814.02602439374 -9195.867493338126 18733.07597328443
# area ll 5.9974536 42.983049 6.947834 43.824352
#
# Alpes Maritimes
# area xy -38321.92423215299 -21699.678849517368 48377.33312269981 80153.99551406642
# area ll 7.2063221 43.460747 7.7389947 44.376752


# ====================================================================================================
# A building

class Building:
    def __init__(self, building, lonlats):
        
        self.building = building
        self.lon = lonlats[0, 0]
        self.lat = lonlats[0, 1]
        
        self.points   = np.empty((len(lonlats), 2), float)
        self.points[:, 0], self.points[:, 1] = lonlat_to_xy(lonlats[:, 0], lonlats[:, 1], PIVOT)
        
        mins = np.min(self.points, axis=0)
        maxs = np.max(self.points, axis=0)
        self.bounds = maxs - mins
        self.location = (mins + maxs)/2
        
    def __str__(self):
        if self.points is None:
            sloc = "Invalid location"
        else:
            sloc = f"{self.location} {self.bounds}"
        return f"<Building @ {self.lon}° {self.lat}° : {self.building} {sloc}>"
    
    def __repr__(self):
        return str(self)

class OSMHandler(osm.SimpleHandler):
    
    def __init__(self):
        osm.SimpleHandler.__init__(self)
        self.node_count = 0
        self.way_count = 0
        self.relation_count = 0
        
        self.buildings = []
        
    def node(self, n):
        self.node_count += 1
            
    def way(self, w):
        self.way_count += 1
        bld = w.tags.get('building')
        if bld is not None:

            lonlats = []
            for n in w.nodes:
                try:
                    lonlats.append((n.lon, n.lat))
                except:
                    pass
                
            if len(lonlats) == 0:
                return
            
            building = Building(bld, np.array(lonlats))
            
            ok = np.sqrt((XY0[0] - building.location[0])**2 + (XY0[1] - building.location[1])**2) < 1000
            if ok or True:
                self.buildings.append(building)
            
    def relation(self, r):
        self.relation_count += 1


def test():        
    osmhandler = OSMHandler()
    osmhandler.apply_file("/Users/alain/Downloads/alpes_maritimes.osm.pbf", locations=True)
    print(f'Number of nodes: {osmhandler.node_count}')
    print(f'Number of way: {osmhandler.way_count}')
    print(f'Number of relations: {osmhandler.relation_count}')
    
    print("Number of buildings:", len(osmhandler.buildings))
    print("\n".join([str(bld) for bld in osmhandler.buildings[:10]]))
    
    blds = osmhandler.buildings
    x0 = blds[0].location[0]
    y0 = blds[0].location[1]
    x1 = x0
    y1 = y0
    
    lon0 = blds[0].lon
    lat0 = blds[0].lat
    lon1 = lon0
    lat1 = lat0
    
    arrays = [bld.points for bld in blds]
    
    info  = np.zeros((len(arrays), 3), int)
    items = np.zeros((0, 2), float)
    for i, array in enumerate(arrays):
        if len(array) == 0:
            continue
        
        info[i, 0] = len(array)
        info[i, 1] = 1000
        
        items = np.append(items, array, axis=0)
        
        #if i > 100000:
        #    break
            
        
    #np.savez("/Users/alain/Downloads/test", *arrays)
    np.savez("/Users/alain/Downloads/test", info=info, items=items)
    
    
test()
